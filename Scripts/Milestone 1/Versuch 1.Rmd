---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r c1}

## creating a data frame df_cl consisting of DepMap_IDs and lineages
lineage <- prism.cl$lineage
DepMap_ID <- prism.cl$DepMap_ID 

df_cl <- data.frame(DepMap_ID, lineage)

## subsetting data frame to obtain only ovary cell lines with their DepMap_IDs

df_ovary_cl <- subset(df_cl, lineage == "ovary")

df_ovary_cl

dim(df_ovary_cl)

## creating a vector with ovary cancer DepMap_IDs 

vector_ovary_DepMI <- as.vector(df_ovary_cl$DepMap_ID)
```


```{r c2}

## creating a subset dataframe of prism with only the ovary DepMap_IDs and their proliferation values   

vector_ovary_DepMI

df_ovary_DepMI_prism  <- subset(prism, DepMap_ID %in% vector_ovary_DepMI)

df_ovary_DepMI_prism
```


```{r c3}
## computing histograms of distribution of mean sensitivity across all ovary cell lines and all drugs

hist_cell_growth_cl  <- hist(apply(df_ovary_DepMI_prism, 1,function(x){mean(x,na.rm=TRUE)}), breaks = 50, xlim = c(-0.9, 0),  main = "Ovary Cell lines", xlab = "Mean log fold-change in cell growth")

hist_cell_growth_drugs <- hist(apply(df_ovary_DepMI_prism, 2,function(x){mean(x,na.rm=TRUE)}), breaks = 50, main = "Drugs", xlab = "Mean log fold-change in cell growth")

hist_cell_growth_cl
hist_cell_growth_drugs
```

```{r c4}
## creating data.frame that contains the most effective treatment values for each drug and dosage (min values) for every cell line 

prism_reduced = data.frame(row.names = rownames(prism))

for (i in 1:(ncol(prism)/8)){
  prism_subset = prism[,(8*(i-1)+1):(8*i)]
  max_effect = apply(prism_subset, 1, min)
  drug = toString(prism.treat$name[which(rownames(prism.treat)== colnames(prism)[i*8])])
  prism_reduced[drug] = max_effect
}

prism_reduced 
## doing the same for ovary cell lines 

prism_reduced_ovary = data.frame(row.names = rownames(df_ovary_DepMI_prism))

for (i in 1:(ncol(df_ovary_DepMI_prism)/8)){
  prism_subset_ovary = df_ovary_DepMI_prism[,(8*(i-1)+1):(8*i)]
  max_effect = apply(prism_subset_ovary, 1, min)
  drug = toString(prism.treat$name[which(rownames(prism.treat)== colnames(prism)[i*8])])
  prism_reduced_ovary[drug] = max_effect
}

prism_reduced_ovary
```


```{r c5}
numeric_prism_reduced_ovary <- lapply(prism_reduced_ovary, as.numeric)


## fml 

for(i in 1:481) {
   i <- i+1
   print(paste(hist(prism_reduced_ovary[,i])))
}

```

```{r c6}

prism_reduced_ovary_mean_values <- apply(prism_reduced_ovary, 2, mean, na.rm=TRUE)


library(ggplot2)

## klappt alles nicht 
# t1 <- as.matrix(prism_reduced_ovary[,1:1394])

# t2 <- as.matrix(prism_reduced_ovary[1:30,])


# cor_t1_t2 <- cor(t1,t2, method = "pearson")


# cor_t1_t2


# geom_boxplot(prism_reduced_ovary)

```



```{r c7}
## trash
## topVar = apply(prism_reduced_ovary, 1, var, na.rm=TRUE)


## summary(topVar)

```

```{r c8}

## fail 

library(ggplot2)
library(colorspace)
library(gridExtra)

prism_reduced_ovary_mean_values

prism_reduced_ovary_mean_values_df <- as.data.frame(prism_reduced_ovary_mean_values)


p = ggplot(prism_reduced_ovary_mean_values_df, aes(x = prism_reduced_ovary_mean_values_df[,], y = prism_reduced_ovary_mean_values_df[,]))
ggtitle("test")
xlab("cell lines")
ylab("meds")
p2 = p 
stat_bin_hex(color="white", na.rm=TRUE)
scale_fill_gradientn(colors=c("purple", "green"), name = "Frequency", na.value=NA)
grid.arrange(p2,ncol=1)



p = ggplot(prism_reduced_ovary_mean_values_df, aes(x = prism_reduced_ovary_mean_values_df[,], y = prism_reduced_ovary_mean_values_df[,]), na.rm=TRUE)
ggtitle("test")
xlab("cell lines")
ylab("meds")
p2 = p + geom_point(alpha = 0.01, color="purple") +
  theme_bw()
grid.arrange(p2,ncol=1)
```


```{r S1: Trying to create a data frame with the prism data using the drug names instead of the Broad IDs}

# Calculating the mean of the proliferation values of ovary cancer cell lines (all drugs) 
apply(df_ovary_DepMI_prism, 1, mean, na.rm = TRUE) 

# Creating a data frame consisting of broad IDs and drug names

BroadIDs <- prism.treat$broad_id
BroadIDs

DrugNames <- prism.treat$name
DrugNames

df_names_BRD <- data.frame(DrugNames, BroadIDs)
df_names_BRD

## this is irrelevant
```

```{r S2 Cut, summarize and paste together}

#Reducing prism to the lowest proliferation value of each drug treatment 

prism_reduced = data.frame(row.names = rownames(prism))

for (i in 1:(ncol(prism)/8)){
  prism_subset = prism[,(8*(i-1)+1):(8*i)]
  max_effect = apply(prism_subset, 1, min)
  drug = toString(prism.treat$name[which(rownames(prism.treat)== colnames(prism)[i*8])])
  prism_reduced[drug] = max_effect
}
```

```{r S3 Plotting the data from prism_reduced}

# Try 1
plot(x = prism_reduced$x_var, y = prism_reduced$y_var) ## Fehlermeldung: error in plot.window(...) : need finite 'xlim' values

#Try 2
qplot(as.matrix(prism_reduced)) ## works, but not sure which values are being shown

#Try 3
ggplot(fortify(prism_reduced)) ## produces only a gray background, not sure why

#Try 4
ggplot(prism_reduced, aes(x = prism_redu, y = prism_reduced[,1:1394])) + geom_point()

#Try 5
hist_prism_reduced <- hist(unlist(prism_reduced), xlab = "Proliferation values", main = "Proliferation values of prism_reduced", breaks = 100) ## THIS IS THE ONE THAT WORKS!! produces similar graph as in try 2

print(hist_prism_reduced)
```

```{r S4 Plotting prism_reduced with a for loop}

## graphing prism_reduced with a for loop

par(mfrow = c(481, 1394))  # Set up a plotting space

# Create the loop.vector (all the columns)
loop.vector <- 1:1394

for (i in loop.vector) { # Loop over loop.vector

  # store data in column.i as x
  x <- prism_reduced[,i]
  
  # Plot histogram of x
  hist(x,
       main = paste("Drug", i),
       xlab = "Cell line",
       xlim = c(0, 100))
}

##this doesn't work
```

```{r S5 Replacing NAs in prism_reduced with the column means}

summary(unlist(prism_reduced))

prism_reduced
prism_reduced_no_NAs = prism_reduced ## create a copy of prism_reduced to keep a version that includes the NAs

for(i in 1:ncol(prism_reduced)){
  prism_reduced_no_NAs[is.na(prism_reduced[, i]), i] <- mean(prism_reduced[, i], na.rm = TRUE)
}  ## this code replaces the NAs in prism_reduced with the col mean and saves it into a new data frame called prism_reduced_no_NAs

hist(unlist(prism_reduced_no_NAs), breaks = 100, xlab = "Proliferation values", main = "Proliferation values of prism_reduced_no_NAs")
```

```{r S6 K means clustering of prism_reduced_no_NAs}

kmeans(prism_reduced_no_NAs, 20) ## Fehlermeldung: Error in do_one(nmeth) : NA/NaN/Inf in foreign function call (arg 1)

# Checking for NA/NaN/Inf values:

is.finite(unlist(prism_reduced_no_NAs)) ## returns all TRUE

is.na(unlist(prism_reduced_no_NAs)) ## returns all FALSE

is.nan(unlist(prism_reduced_no_NAs)) ## returns all FALSE

# what is the problem????
```


```{r S7 Schwellenwert festlegen um unsignifikante Medikamente aus prism_reduced zu entfernen}



```


---
bibliography: ../Bibliography/References.bibtex
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
```

```{r, include=FALSE}
load("../Original_Environment/prism_datasets.rda")
load("../Original_Environment/cellline_datasets.rda")
```

```{r, include = FALSE}

## lineage
lineage <- prism.cl$lineage

## DepMap_ID
DepMap_ID <- prism.cl$DepMap_ID

## df_cl
df_cl <- data.frame(DepMap_ID, lineage)

## df_ovary_cl
df_ovary_cl <- subset(df_cl, lineage == "ovary")

## vector_ovary_DepMI
vector_ovary_DepMI <- as.vector(df_ovary_cl$DepMap_ID)

## prism_reduced
prism_reduced = data.frame(row.names = rownames(prism))

for (i in 1:(ncol(prism)/8)){
  prism_subset = prism[,(8*(i-1)+1):(8*i)]
  max_effect = apply(prism_subset, 1, min)
  drug = toString(prism.treat$name[which(rownames(prism.treat)== colnames(prism)[i*8])])
  prism_reduced[drug] = max_effect
}

prism_reduced_all = prism_reduced

prism_reduced = prism_reduced[-which(rownames(prism_reduced) %in% vector_ovary_DepMI),]

prism_reduced = prism_reduced[, !is.na(apply(prism_reduced, 2, mean, na.rm = TRUE))]

## min_values_treat_prism_reduced
min_values_treat_prism_reduced <- apply(prism_reduced, 2, min, na.rm=TRUE)

## min_values_treat_prism_reduced_vector
min_values_treat_prism_reduced_vector <- as.vector(min_values_treat_prism_reduced)

## prism_reduced_under_threshold 
prism_reduced_under_threshold = data.frame(min_values_treat_prism_reduced[min_values_treat_prism_reduced < quantile(min_values_treat_prism_reduced_vector, 0.1)])

## prism.treat_reduced
prism.treat_reduced <- prism.treat[which(prism.treat$name %in% rownames(prism_reduced_under_threshold)),]

prism.treat_reduced = prism.treat_reduced[seq(1, nrow(prism.treat_reduced),8),]

prism.treat_reduced = droplevels(prism.treat_reduced)

## Creating a new dataframe that only includes columns that are interesting for us
prism.treat_reduced_2 = prism.treat_reduced[,which(colnames(prism.treat_reduced) %in% c("name", "moa", "target", "disease.area", "indication", "broad_id"))]

## prism.treat_reduced_2
prism.treat_reduced_2 = prism.treat_reduced[,which(colnames(prism.treat_reduced) %in% c("name", "moa", "target", "disease.area", "indication", "broad_id"))]

```


# Milestone 1.2

## Mechanism of action

```{r, echo=FALSE, fig.cap = "Most frequent MOA's amongst the most effective drugs"}

moa_frequencies = prism.treat_reduced_2 %>% count(moa) %>% filter(n >= 3)
moa_frequencies = moa_frequencies[0:9,]

par(mar=c(4, 20, 4, 4))
barplot(moa_frequencies$n, names.arg = moa_frequencies$moa, 
        las = 1, 
        xlab = "Frequency", 
        horiz = TRUE, 
        xlim = c(0,10),
        col = "Lightblue3",
        main = NULL) 

```

After finding the drugs with the most effective response in regards to the ovary cancer cell lines, we now continued our analysis by testing if the efficiency of these drugs is dependent on the cancer cell line type or not. In order to test this we repeated many of the same steps as in milestone 1.1 but on all cell lines except the ovary cell lines. We extracted the most negative proliferation value for each drug in each cell line (except ovary), set the threshold to the 10% quantile, and then extracted the most common MOAs.

As can be seen in Fig. X, all but one of the most frequently occurring MOAs are the same as the most frequently occurring MOAs in ovary cancer cell lines, however; the frequency with which they occur in the other cell lines differs slightly from the frequency with which they occur in the ovary cell lines. The NFkB pathway inhibitor is the one MOA that appears among the 45 most frequent MOAs in the other cell lines three times but not at all in the 45 most frequent MOAs in the ovary cell lines. Although NFkB pathway inhibitors do occur in the ovary cell lines twice, this is not often enough to have made the top 45 which explains why they are not shown in Fig 2.b. NFkB transcription factors are often used to regulate inflammation and immune responses, cell growth, apoptosis, and the expression of certain viral genes [@Gilmore2006]. Due to the importance of the NFkB transcription factors in regulating these processes, NFkB pathway inhibitors are often used in treating chronic inflammation and cancer [@Gilmore2006]. 

## Fisher - Exact Tests

```{r, include = FALSE}

## fisher test topoisomerase inhibitors

fisher_topoisomerase <- data.frame(c(9,9), c(131,131), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_topoisomerase) <- c("Topoisomerase Inhibitor", "Other")

## fisher test hdac inhibitors

fisher_hdac <- data.frame(c(10,9), c(130, 131), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_hdac) <- c("HDAC Inhibitor", "Other")

## fisher test cdk inhibitor

fisher_cdk <- data.frame(c(7,5), c(133,135), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_cdk) <- c("CDK Inhibitor", "Other")

## ## fisher test proteasome inhibitor

fisher_proteasome <- data.frame(c(6,4), c(134,136), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_proteasome) <- c("Proteasome Inhibitor", "Other")

## fisher PI3

fisher_PI3K <- data.frame(c(3,3), c(137,137), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_cdk) <- c("PI3K Inhibitor", "Other")

## fisher EGFR

fisher_EGFR <- data.frame(c(3,4), c(137,136), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_cdk) <- c("EGFR Inhibitor", "Other")

## fisher BCL

fisher_BCL <- data.frame(c(3,4), c(137,136), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_BCL) <- c("BCL Inhibitor", "Other")

## fisher ATPase 

fisher_ATPase <- data.frame(c(4,4), c(136,136), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_ATPase) <- c("ATPase Inhibitor", "Other")

## fisher NFkB

fisher_NFkB <- data.frame(c(2,3), c(138,137), row.names = c("Ovary Cell Lines", "Non-Ovary Cell Lines"))

colnames(fisher_ATPase) <- c("NFkB pathway Inhibitor", "Other")


```


```{r, include = FALSE}

fisher.test(fisher_topoisomerase)
fisher.test(fisher_proteasome)
fisher.test(fisher_PI3K)
fisher.test(fisher_NFkB)
fisher.test(fisher_hdac)
fisher.test(fisher_EGFR)
fisher.test(fisher_cdk)
fisher.test(fisher_BCL)
fisher.test(fisher_ATPase)

```


```{r, echo = FALSE, fig.cap = "Barplot showing all p-values and OR"}

par(mar=c(10,10,2,2))
barplot(c(1, 1, 0.7494, 1.520121, 1, 1, 1,  0.6628035, 1, 1.119206, 1, 0.7453084, 0.7694, 1.419276, 1, 0.7453084, 1, 1),
        names.arg = c("Topoisomerase p-value", "Topoisomerase OR", "Proteasome p-value", "Proteasome OR", "PI3K p-value", "PI3K OR", "NFkB p-value", "NFkB OR", "HDAC p-value", "HDAC OR", "EGFR p-value", "EGFR OR", "CDK p-value", "CDK OR", "BCL p-value", "BCL OR", "ATPase p-value", "ATPase OR"),
        las = 2,
        col = c("Lightblue3", "Lightblue3", "Lightblue1", "Lightblue1", "Lightblue3", "Lightblue3", "Lightblue1", "Lightblue1", "Lightblue3", "Lightblue3", "Lightblue1", "Lightblue1", "Lightblue3", "Lightblue3", "Lightblue1", "Lightblue1", "Lightblue3", "Lightblue3", "Lightblue1", "Lightblue1", "Lightblue3", "Lightblue3", "Lightblue1", "Lightblue1", "Lightblue3", "Lightblue3", "Lightblue1", "Lightblue1"),
        ylim = c(0, 1.7))

```

After finding the most common MOAs among the ovary and all other cell lines respectively, the next step in our analysis was to find out if any of these MOAs showed a statistically significant occurrence in ovary cancer specifically. In order to test this, we decided to perform a fisher-exact-test on all of our selected most common MOAs for ovary cancer and all other cell lines (see Fig. X).

In order for the null hypothesis - that there is no association between the occurrence of specific MOAs and the cell line type (either ovary or non-ovary) - to be rejected, the p-value must be smaller than the confidence level of 0.05. This was not the case with any of the fisher tests that we conducted. For the fisher tests conducted on the topoisomerase inhibitor, the PI3K inhibitor, the NFkB pathway inhibitor, the HDAC inhibitor, the EGFR inhibitor, the BCL inhibitor, and the ATPase inhibitor the p-values were equal to one, as were the odds-ratios. This shows without a doubt that the H0-hypothesis cannot be rejected and that there therefore is no association between the occurrence of specific MOAs and the cell line type (either ovary or the others) for these MOAs. The fisher tests conducted on the remaining MOAs all calculate a p-value that is lower than 1, none of which are lower than 0.7 however. The odds ratios for these remaining MOAs are all either larger than one or lower than one, which would suggest a positive/negative association, respectively. Since the corresponding p-values are much larger than the confidence level of 0.5 however, these associations are most likely due to chance and aren't true associations. Conclusively these fisher tests have shown that not a single one of the most common MOAs among our cell lines occur so commonly due to an association to a specific cell line (either ovary or the others).

## PC1 vs. PC2 for All Cell Line Clusters

```{r, include = FALSE}

## prism_reduced_all_no_NAs
prism_reduced_all_no_NAs = prism_reduced_all

## prism_reduced_no_NAs 
prism_reduced_no_NAs = prism_reduced 

for(i in 1:ncol(prism_reduced)){
  prism_reduced_no_NAs[is.na(prism_reduced[, i]), i] <- mean(prism_reduced[, i], na.rm = TRUE)
  prism_reduced_all_no_NAs[is.na(prism_reduced_all[, i]), i] <- mean(prism_reduced_all[, i], na.rm = TRUE)
}  

## Extracting the medication names of topoisomerase moas
topoisomerase_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "topoisomerase inhibitor",])$name)) 

## Extracting the medication names of proteasome moas
proteasome_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "proteasome inhibitor",])$name)) 

## Extracting the medication names of PI3K moas
PI3K_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "PI3K inhibitor",])$name)) 

## Extracting the medication names of NFkB_pathway moas
NFkB_pathway_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "NFkB_pathway inhibitor",])$name)) 

## Extracting the medication names of HDAC moas
hdac_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "HDAC inhibitor",])$name)) 

## Extracting the medication names of EGFR moas
EGFR_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "EGFR inhibitor",])$name)) 

## Extracting the medication names of CDK moas
CDK_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "CDK inhibitor",])$name)) 

## Extracting the medication names of BCL moas
BCL_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "BCL inhibitor",])$name)) 

## Extracting the medication names of ATPase moas
ATPase_inhibitors = as.vector(na.omit((prism.treat_reduced_2[prism.treat_reduced_2$moa == "ATPase inhibitor",])$name)) 

## Combining all the medication names into one vector 

most_effective_moas_drugs = c(topoisomerase_inhibitors, proteasome_inhibitors, PI3K_inhibitors, NFkB_pathway_inhibitors, hdac_inhibitors, EGFR_inhibitors, CDK_inhibitors, BCL_inhibitors, ATPase_inhibitors)

## names_use
names_use <- names(prism_reduced_no_NAs)[names(prism_reduced_no_NAs) %in% most_effective_moas_drugs]

## moa_drugs_all
moa_drugs_all = prism_reduced_all_no_NAs[,names_use]

```


```{r, echo = FALSE, fig.cap = "PC1 vs. PC2 for All Cell Line Clusters"}

A_moa_all = as.matrix(moa_drugs_all)

pca1_moa_all = prcomp(A_moa_all[,-42], scale = TRUE)

colVec = vector(length = nrow(A_moa_all))
colVec[which(rownames(A_moa_all) %in% df_ovary_cl$DepMap_ID)] = "red"
colVec[-which(rownames(A_moa_all) %in% df_ovary_cl$DepMap_ID)] = "gray"

plot(pca1_moa_all$x[,1], pca1_moa_all$x[,2], pch=20, col = colVec, 
     xlab='PC1',ylab='PC2',
      main = "PC1 vs. PC2 for All Cell Line Clusters")
      legend("topleft", legend = c("Ovary cell lines", "Other cell lines"), fill = c("Red", "Gray"))

```

As a next step we decided to perform a PCA on all cell lines. We clustered by cell lines in order to test if the ovary cell lines would form their own distinctive cluster regarding the drug response. As can be seen in Fig. X, this was not the case. The red dots representing the ovary cancer cell lines are distributed across the entire plot, rather than concentrated into one distinctive cluster. The fact that the ovary cell lines did not form their own cluster shows that there seems to be no combining trait among them that would trigger a similar drug response. 

---
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyr)
library(readr)
library(dplyr)
library(plyr)
library(ggplot2)
library(ggcorrplot)
library(devtools)
library(tinytex)

```

```{r, include = FALSE}

load("../Original_Environment/prism_datasets.rda")
load("../Original_Environment/cellline_datasets.rda")

```

## Visualization - Boxplot
```{r out.width = "70%", echo = FALSE, fig.cap="**1.** Boxplot of the distribution of the proliferation rates of ovary cell lines according to the drug dosage", fig.height = 3, fig.width = 8, fig.align = 'center', cex.axis = 0.75}

dosage<- prism.treat$dose
broadID<- prism.treat$broad_id

df_treat <- data.frame(broadID, dosage)

broadID2<- prism.treat[,0]

broadID3<-rownames(prism.treat)

df_treat2<- data.frame (broadID2, dosage)

df_treat_lowdose<-df_treat[dosage<2.5, c("broadID","dosage")]

df_treat_highdose<-df_treat[dosage>=2.5, c("broadID","dosage")]



lineage <- prism.cl$lineage
DepMap_ID <- prism.cl$DepMap_ID 

df_cl <- data.frame(DepMap_ID, lineage)

df_ovary_cl <- subset(df_cl, lineage == "ovary")


vector_ovary_DepMI <- as.vector(df_ovary_cl$DepMap_ID)


df_ovary_DepMI_prism  <- prism[rownames(prism) %in% vector_ovary_DepMI,]


new_df_ovary_DepMI_prism<- as.data.frame(t(df_ovary_DepMI_prism))



df_ovary_DepMI_prism_treat <-merge(prism.treat,new_df_ovary_DepMI_prism , by="row.names")


df_ovary_DepMI_prism_treat[,c('screen_id','compound_plate','moa','target','disease.area','indication','smiles','phase')]<-list(NULL)


df_ovary_DepMI_prism_treat_NAs<-drop_na(df_ovary_DepMI_prism_treat)

most_effective_moas_drugs<-c("TAS-103","nemorubicin","idarubicin","10-hydroxycamptothecin", "amsacrine","SN-38","doxorubicin","exatecan-mesylate","genz-644282","ixazomib-citrate","carfilzomib","delanzomib","ixazomib","BGT226","buparlisib","CUDC-907","PCI-24781","AR-42", "givinostat","scriptaid","M-344","romidepsin","trichostatin-a","vorinostat","JNJ-26481585","pelitinib","PD-168393","dacomitinib","afatinib","AT-7519","dinaciclib","CR8-(R)","P276-00" ,"R547","oridonin","obatoclax","HA14-1","TW-37","digoxin","thonzonium","digitoxigenin","NMS-873")

df_ovary_prism_treat_effective <- df_ovary_DepMI_prism_treat[df_ovary_DepMI_prism_treat$name %in% most_effective_moas_drugs,]

df_lowdose<- df_ovary_DepMI_prism_treat[-which(df_ovary_DepMI_prism_treat$dose>2,5),]

df_lowdose_NAs<-df_ovary_DepMI_prism_treat_NAs[-which(df_ovary_DepMI_prism_treat_NAs$dose>2,5),]

df_highdose<- df_ovary_DepMI_prism_treat[-which(df_ovary_DepMI_prism_treat$dose<=2,5),]

df_highdose_NAs<-df_ovary_DepMI_prism_treat_NAs[-which(df_ovary_DepMI_prism_treat_NAs$dose<=2,5),]

df_lowdose_effectivedrugs<- df_ovary_prism_treat_effective[-which(df_ovary_prism_treat_effective$dose>2,5),]


df_highdose_effectivedrugs<- df_ovary_prism_treat_effective[-which(df_ovary_prism_treat_effective$dose<=2,5),]

df_ovary_prism_treat_effective_long<-pivot_longer(df_ovary_prism_treat_effective,cols = starts_with("ACH"),names_to= "DepMap_ID", values_to="proliferationvalues", values_drop_na=TRUE)

ggplot_dose_proliferationvalues<-ggplot(df_ovary_prism_treat_effective_long, aes(x=dose, y=proliferationvalues)) +
  geom_point()+
  labs(title="Plot of proliferation value per dose",x="Dose (Âµm)", y = "proliferation value")

df_ovary_prism_treat_effective_long$dose_high_low <- df_ovary_prism_treat_effective_long$dose
for(i in 1:nrow(df_ovary_prism_treat_effective_long)){
  if(df_ovary_prism_treat_effective_long$dose[i] < 2){
    df_ovary_prism_treat_effective_long$dose_high_low[i]="0<=2"
  } else if(df_ovary_prism_treat_effective_long$dose[i] >= 2 & df_ovary_prism_treat_effective_long$dose[i] <= 7.5){
    df_ovary_prism_treat_effective_long$dose_high_low[i]="2<7.5"
  } else if(df_ovary_prism_treat_effective_long$dose[i] > 7.5){
    df_ovary_prism_treat_effective_long$dose_high_low[i]="7.5<11"
  }
}


ggplot_plot_boxplot_dose_proliferation <- ggplot(df_ovary_prism_treat_effective_long, aes(x=dose_high_low, y=proliferationvalues)) + geom_boxplot(outlier.shape=8, aes(fill=dose_high_low))+labs(x="Dose (micromolar)", y = "Proliferation value")
ggplot_plot_boxplot_dose_proliferation

```
Therefore, a boxplot of the distribution of the proliferation rates, regarding the drug dose was performed. We could not divide the boxplot by the 2.5 micromolar dosage, but rather in 3 stages: low dose, median dose and high dose, corresponding with a highest median proliferation rate, median rate and lowest rate, respectively. Consequently, an increasing of drug dose leads to reduction of proliferation rates.

## Pearson Correlation
Almost all Pearson correlation coefficients are negative, except for one between 'ACH-000713' and 'exatecan-mesylate'. It has a positive value and thus is an outlier(measurement error). Consequently,some drugs have a quite strong negative correlation with proliferation, while others do not affect it.

## Visualization - GGPLOT
Furthermore, we created correlation matrix from the dosages of the different drugs per cell line and displayed graphically the Pearson correlation. The blue and the purple squares indicate higher correlation, meaning that the majority of the drugs reduce the cell proliferation.

```{r out.width = "70%",echo=FALSE, error=FALSE, fig.cap="**2.** ggplot of the correlation between the proliferation rates of ovary cell lines and the dosage of the applied medical treatment", fig.height=5,fig.weight=9, message=FALSE, warning=FALSE, results='hide', fig.align='center', cex.axis = 0.75}

cordf_effective= data.frame(row.names=rownames(prism))

for (drug in unique(df_ovary_prism_treat_effective$name)){
  dose = prism.treat[prism.treat$name==drug,]$dose
  response = prism[,rownames(prism.treat)[prism.treat$name == drug]]
  
  cordf_effective[drug]=apply(response,1,function(x){cor(x,dose)})
}
cordf_effective<-cordf_effective[rownames(cordf_effective) %in% vector_ovary_DepMI,]

cormatrix_effective<- data.matrix(cordf_effective)


cf <- coord_fixed()
cf$default <- TRUE
ggplot2_dose_proliferation<-ggcorrplot(cormatrix_effective, tl.cex = 7.5 )+ 
  cf +
  coord_fixed(xlim = c(15, 7))
 
ggplot2_dose_proliferation + coord_flip()

```






---
title: "Dependence of drug dose and ovary cell lines proliferation rates"
author: "Rositsa Todorovska"
date: 
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyr)
library(readr)
library(dplyr)
library(plyr)
library(ggplot2)
library(ggcorrplot)
library(devtools)
library(tinytex)

```

```{r, include = FALSE}

load("../Original_Environment/prism_datasets.rda")
load("../Original_Environment/cellline_datasets.rda")

```


## GENERAL

In Milestone 1.3 our goal was to show how the dosage of the medical treatment affects the treatment results.

## ANALYSIS OF THE RESULTS AND THE PROCEDURE

At the beginning of our analysis for this milestone, we reduced the prism data frame only to the ovary cell lines and reversed the x-axis with the y-axis. Then we merged the reduced data frame with prism.treat dataset, thereby deleting all not needed columns, and created a new data frame 'df_ovary_DepMI_prism_treat' which we worked with in our further analysis.

According to the experimental methods, implied in the scientific paper (Corsello et al. 2020), we used the single dose 2.5 micromolar of the drugs as a marker to divide them into subgroups.

Then we created a vector containing only the most effective drugs from milestones 1.1 and 1.2 'most_effective_moas_drugs2'.
In order to create a data frame with the most effective drugs from the previous milestones, a reduction of the 'df_ovary_DepMI_prism_treat' data frame to the most effective moa drugs from the mentioned milestones was conducted.

Proceeding to the further analysis, a ggplot and a boxplot were implemented to plot the dosage against the ovary cell lines proliferation values and demonstrate how the proliferation values change with an increasing or decreasing dosage of the medicaments. 


## VISUALIZATION - BOXPLOT


```{r, include = FALSE, echo = FALSE, fig.cap="**1.** Boxplot of the distribution of the proliferation rates of ovary cell lines according to the drug dosage", fig.height = 3, fig.width = 8, fig.align = 'center'}

dosage<- prism.treat$dose
broadID<- prism.treat$broad_id

df_treat <- data.frame(broadID, dosage)

broadID2<- prism.treat[,0]

broadID3<-rownames(prism.treat)

df_treat2<- data.frame (broadID2, dosage)

df_treat_lowdose<-df_treat[dosage<2.5, c("broadID","dosage")]

df_treat_highdose<-df_treat[dosage>=2.5, c("broadID","dosage")]



lineage <- prism.cl$lineage
DepMap_ID <- prism.cl$DepMap_ID 

df_cl <- data.frame(DepMap_ID, lineage)

df_ovary_cl <- subset(df_cl, lineage == "ovary")


vector_ovary_DepMI <- as.vector(df_ovary_cl$DepMap_ID)


df_ovary_DepMI_prism  <- prism[rownames(prism) %in% vector_ovary_DepMI,]


new_df_ovary_DepMI_prism<- as.data.frame(t(df_ovary_DepMI_prism))



df_ovary_DepMI_prism_treat <-merge(prism.treat,new_df_ovary_DepMI_prism , by="row.names")


df_ovary_DepMI_prism_treat[,c('screen_id','compound_plate','moa','target','disease.area','indication','smiles','phase')]<-list(NULL)


df_ovary_DepMI_prism_treat_NAs<-drop_na(df_ovary_DepMI_prism_treat)


df_ovary_prism_treat_effective <- df_ovary_DepMI_prism_treat[df_ovary_DepMI_prism_treat$name %in% most_effective_moas_drugs2,]

df_ovary_prism_treat_effective_long<-pivot_longer(df_ovary_prism_treat_effective,cols = starts_with("ACH"),names_to= "DepMap_ID", values_to="proliferationvalues", values_drop_na=TRUE)



ggplot_plot_boxplot_dose_proliferation <- ggplot(df_ovary_prism_treat_effective_long, aes(x=dose_high_low, y=proliferationvalues)) + geom_boxplot(outlier.shape=8, aes(fill=dose_high_low))+labs(x="Dose (micromolar)", y = "Proliferation value")
ggplot_plot_boxplot_dose_proliferation

```
Therefore, a visualization with a boxplot to show the distribution of the proliferation rates of the ovary cell lines, regarding the drug dose was performed. Unfortunately, we could not divide the boxplot according to the 2.5 micromolar dosage. However, the boxplot was divided in three dose-stages: low dose, median dose and high dose. The highest median proliferation value was observed by the lowest dosage 0<=2 micromolar, by dosage 2<7.5 micromolar there was an increase of the median, whereas by the highest dosage  7.5<11 micromolar the corresponding median was at the lowest. This means that with an increasing dose of the medicaments, the proliferation rates are reduced.


## PEARSON CORRELATION

In order to show how the dosage of the medical treatment affects the proliferation and viability of the ovary cell lines, a Pearson correlation between the dose of the drugs and the proliferation value was performed. Almost all Pearson correlation coefficients have negative values, except for one between the cell line 'ACH-000713' and the drug 'exatecan-mesylate'. In comparison with the other coefficients, this has a positive value and can be considered as an outlier. A reason for this could be a measurement error, because there is only one cell line with such value. We implemented specifically a ggplot which demonstrated that there is an outlier.
Consequently,there is an inverse negative correlation. Some medicaments show a very strong correlation with the proliferation of the cell lines, while others almost do not affect it.

## VISUALIZATION - GGPLOT

Furthermore, we created the correlation matrix from the dosages of the different medicaments per cell line and to display graphically the Pearson correlation, the function ggcorrplot() on the created correlation matrix was applied. As you can see, the blue and the purple squares which indicate higher correlation, ranging from 0.0 to -1.0 are in prevalence, meaning that the majority of the drugs reduce the cell proliferation. A Pearson correlation histogram showed the frequency of the Pearson correlation values, with most frequent values between -0.9 and -1.0.


```{r out.width = "70%", include = FALSE,echo=FALSE, error=FALSE, fig.cap="**2.** ggplot of the correlation between the proliferation rates of ovary cell lines and the dosage of the applied medical treatment", fig.height=5,fig.weight=9, message=FALSE, warning=FALSE, results='hide', fig.align='center'}

cordf_effective= data.frame(row.names=rownames(prism))

for (drug in unique(df_ovary_prism_treat_effective$name)){
  dose = prism.treat[prism.treat$name==drug,]$dose
  response = prism[,rownames(prism.treat)[prism.treat$name == drug]]
  
  cordf_effective[drug]=apply(response,1,function(x){cor(x,dose)})
}
cordf_effective<-cordf_effective[rownames(cordf_effective) %in% vector_ovary_DepMI,]

cormatrix_effective<- data.matrix(cordf_effective)


cf <- coord_fixed()
cf$default <- TRUE
ggplot2_dose_proliferation<-ggcorrplot(cormatrix_effective, tl.cex = 7.5 )+ 
  cf +
  coord_fixed(xlim = c(15, 7))
 
ggplot2_dose_proliferation + coord_flip()

```

